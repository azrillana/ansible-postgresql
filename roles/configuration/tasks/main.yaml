- name: Ensure PostgreSQL is listening on *
  lineinfile:
    dest: /etc/postgresql/12/main/postgresql.conf
    regexp: '^listen_addresses\s*='
    line: "listen_addresses='*'"
    state: present
  notify: Restart Postgresql

- name: Add new configuration to "pg_hba.conf"
  blockinfile:
    dest: /etc/postgresql/12/main/pg_hba.conf
    block: |
      host    all             all             0.0.0.0/0                md5
      host    all             all             ::/0                     md5
  notify: Restart Postgresql

- name: Change peer identification to trust
  shell: /bin/sed -i '/^local/s/peer/trust/' /etc/postgresql/12/main/pg_hba.conf
  args:
    warn: no
  notify: Restart Postgresql

- name: Check if PostgreSQL is running
  systemd:
    name: postgresql.service
    state: started
  register: postgres_status
  ignore_errors: yes

- name: Change password postgres user
  become: yes
  become_method: sudo
  become_user: postgres
  postgresql_user: 
    db: postgres
    name: postgres
    password: "Task@4ND4L111"  
  when: postgres_status is success
